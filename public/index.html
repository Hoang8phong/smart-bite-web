<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Nearest Restaurants – SmartBite</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg-body: #f5f1e8;
      --bg-panel: #faf7f0;
      --bg-card: #ffffff;
      --green-deep: #137a7f;
      --green-main: #86cecb;
      --green-soft: #d6e4d6;
      --beige-soft: #f0e3cf;
      --text-main: #1f2933;
      --text-muted: #6b7280;
      --border-soft: #e0d8c7;
      --accent: #e0643a;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-body);
      color: var(--text-main);
    }

    a { color: var(--green-main); text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* Header */

    .top-bar {
      background: var(--green-deep);
      color: #f9fafb;
      padding: 10px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #183022;
    }

    .top-brand {
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      font-size: 14px;
    }

    .top-actions {
      display: flex;
      gap: 8px;
      font-size: 12px;
    }

    .pill-btn {
      border: 1px solid #e5e7eb;
      background: rgba(249, 250, 251, 0.06);
      color: #f9fafb;
      padding: 4px 10px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 11px;
    }
    .pill-btn:hover {
      background: rgba(249, 250, 251, 0.16);
    }

    /* Main layout*/

    .page {
      max-width: 1280px;
      margin: 0 auto;
      padding: 20px 20px 32px;
    }

    .hero {
      display: flex;
      gap: 16px;
      background: linear-gradient(90deg, var(--green-main), #3f7b50);
      color: #f9fafb;
      padding: 18px 20px;
      border-radius: 8px;
      border: 1px solid #214634;
      margin-bottom: 18px;
    }

    .hero-main {
      flex: 1 1 60%;
    }

    .hero-title {
      margin: 0 0 4px;
      font-size: 22px;
      font-weight: 600;
      color: #000000;
    }

    .hero-sub {
      margin: 0;
      font-size: 13px;
      color: #000000;
    }

    .hero-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 8px;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(245, 250, 247, 0.12);
      border: 1px solid rgba(229, 231, 235, 0.3);
    }

    .hero-side {
      flex: 1 1 40%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: flex-end;
      font-size: 11px;
      gap: 4px;
      text-align: right;
    }

    .hero-tagline {
      background: rgba(250, 250, 250, 0.12);
      border-radius: 4px;
      padding: 4px 8px;
      border: 1px solid rgba(229, 231, 235, 0.25);
    }

    .hero-note {
      opacity: 0.88;
    }

    /* Shell: filters + content */

    .panel {
      background: var(--bg-panel);
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      padding: 14px 14px 10px;
      margin-bottom: 18px;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 8px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .panel-title {
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: var(--green-deep);
    }

    .panel-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* form filters */

    form {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: flex-start;
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 11px;
      color: var(--text-muted);
      flex: 1 1 140px;
      min-width: 140px;
    }

    .field-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      width: 100%;
    }

    input, select, button {
      font-family: inherit;
      font-size: 12px;
      padding: 7px 8px;
      border-radius: 4px;
      border: 1px solid #d4d4cf;
      background: #ffffff;
      color: var(--text-main);
    }

    input:focus,
    select:focus {
      outline: 1px solid var(--green-main);
      border-color: var(--green-main);
    }

    button {
      cursor: pointer;
      background: var(--green-main);
      color: #f9fafb;
      font-weight: 500;
      border-color: #24523a;
    }

    button.secondary {
      background: var(--beige-soft);
      color: var(--green-deep);
      border-color: #d2c3a7;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    label {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .checkbox-label {
      margin-top: 18px;
    }

    /* Help text */

    details {
      font-size: 11px;
      margin-top: 6px;
      color: var(--text-muted);
    }

    details summary {
      cursor: pointer;
      font-weight: 500;
      margin-bottom: 4px;
    }

    details ul {
      margin: 4px 0;
      padding-left: 18px;
    }

    /* Main content grid: list + map */

    .content-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
      gap: 14px;
      align-items: start;
    }

    @media (max-width: 960px) {
      .hero {
        flex-direction: column;
      }
      .hero-side {
        align-items: flex-start;
        text-align: left;
      }
      .content-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    #results-head {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    #results {
      font-size: 13px;
    }

    .result-card {
      background: var(--bg-card);
      border-radius: 6px;
      border: 1px solid var(--border-soft);
      padding: 10px 11px;
      margin-bottom: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .result-card:hover {
      border-color: var(--green-main);
      background: #fdfbf5;
    }

    .result-card.active {
      border-color: var(--green-main);
      background: #f5faf5;
    }

    .result-header {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: baseline;
    }

    .result-name {
      font-weight: 600;
    }

    .result-meta {
      font-size: 12px;
      color: var(--text-muted);
    }

    .dur {
      font-weight: 600;
      font-size: 12px;
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .tag {
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #f7f4ec;
    }

    /* Map */

    #map {
      width: 100%;
      height: 420px;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: #dde5d7;
    }

  </style>
</head>
<body>

  <header class="top-bar">
    <div class="top-brand">SmartBite • Nearby Restaurants</div>
    <div class="top-actions">

    </div>
  </header>

  <main class="page">
    <!-- Hero -->
    <section class="hero">
      <div class="hero-main">
        <h1 class="hero-title">Find a place to eat, fast.</h1>
        <p class="hero-sub">
          Search nearby restaurants based on your current location, walking or driving time,
          rating and price levels – powered by Google Maps Platform.
        </p>
        <div class="hero-badge">
          <span>Realtime distance · Travel time · Filters</span>
        </div>
      </div>
      <div class="hero-side">
        <div class="hero-tagline">
        </div>
      </div>
    </section>

    <!-- Panel filters -->
    <section class="panel">
      <div class="panel-header">
        <div class="panel-title">Search settings</div>
        <div class="panel-subtitle">

        </div>
      </div>

      <form id="f">
        <div class="field-row">
          <div class="field-group">
            <span>Address or place (optional)</span>
            <input id="address" placeholder="e.g. Central Station, Sydney NSW">
          </div>
          <div class="field-group" style="max-width: 130px;">
            <span>&nbsp;</span>
            <button id="resolve" class="secondary" type="button">Resolve → lat/lng</button>
          </div>
          <div class="field-group">
            <span>Latitude</span>
            <input id="lat" type="number" step="any" required>
          </div>
          <div class="field-group">
            <span>Longitude</span>
            <input id="lng" type="number" step="any" required>
          </div>
        </div>

        <div class="field-row">
          <div class="field-group" style="max-width: 120px;">
            <span>Radius (metres)</span>
            <input id="radius" type="number" value="1500" min="100" max="5000">
          </div>
          <div class="field-group" style="max-width: 120px;">
            <span>Mode</span>
            <select id="mode">
              <option value="walking">walking</option>
              <option value="driving">driving</option>
            </select>
          </div>
          <div class="field-group checkbox-label" style="max-width: 130px;">
            <label><input id="openNow" type="checkbox"> open now only</label>
          </div>
          <div class="field-group">
            <span>Keyword (optional)</span>
            <input id="keyword" placeholder="e.g. sushi, vegan, pizza">
          </div>
        </div>

        <div class="field-row">
          <div class="field-group" style="max-width: 110px;">
            <span>Min rating</span>
            <input id="minRating" type="number" step="0.1" min="0" max="5" placeholder="0–5">
          </div>
          <div class="field-group" style="max-width: 150px;">
            <span>Price levels</span>
            <select id="priceLevels" multiple size="3" title="Hold Ctrl to multi-select">
              <option value="0">$ (cheap)</option>
              <option value="1">$$ (mid)</option>
              <option value="2">$$$ (expensive)</option>
              <option value="3">$$$$ (very expensive)</option>
              <option value="4">$$$$$ (luxury)</option>
            </select>
          </div>
          <div class="field-group" style="max-width: 90px;">
            <span>Page</span>
            <input id="page" type="number" value="1" min="1">
          </div>
          <div class="field-group" style="max-width: 110px;">
            <span>Per page</span>
            <input id="pageSize" type="number" value="10" min="1" max="20">
          </div>
          <div class="field-group" style="max-width: 120px;">
            <span>&nbsp;</span>
            <button id="submitBtn" type="submit">Search</button>
          </div>
          <div class="field-group" style="max-width: 130px;">
            <span>&nbsp;</span>
            <button id="geo" class="secondary" type="button">Use my location</button>
          </div>
        </div>
      </form>

      <details>
        <summary>What do these settings mean?</summary>
        <ul>
          <li><b>Latitude / Longitude</b>: the centre point of your search (usually from GPS).</li>
          <li><b>Radius</b>: how far around that point we look for restaurants (100–5000 m).</li>
          <li><b>Mode</b>: walking or driving – used when calculating travel time.</li>
          <li><b>Open now</b>: show only places that are currently open.</li>
          <li><b>Keyword</b>: text filter such as “sushi”, “vegan”, “pizza”.</li>
          <li><b>Min rating</b>: only display restaurants with rating ≥ this value.</li>
          <li><b>Price levels</b>: Google’s price level 0–4 mapped to $–$$$$$.</li>
          <li><b>Page / Per page</b>: client-side pagination for the filtered results.</li>
        </ul>
      </details>
    </section>

    <!-- Main content: list + map -->
    <section class="content-grid">
      <div>
        <div id="results-head"></div>
        <div id="results"></div>
      </div>
      <div>
        <div id="map"></div>
      </div>
    </section>
  </main>

  <script>
  // --- Helpers to call backend APIs ---
  const api = (body) =>
    fetch("/api/search", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    }).then((r) => r.json());

  async function resolveAddress(q) {
    const res = await fetch("/api/resolve", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ q }),
    });
    return res.json();
  }

  function selectedPriceLevels() {
    return Array.from(priceLevels.selectedOptions).map((o) => Number(o.value));
  }

  function priceText(pl) {
    const n = Number(pl);
    if (!Number.isFinite(n)) return "";
    return "$".repeat(n + 1);
  }

  // --- Map state + helpers ---
  let map;
  let markers = [];
  const markerById = new Map();

  window.initMap = function initMap() {
    const center = { lat: -33.8688, lng: 151.2093 }; // Sydney
    map = new google.maps.Map(document.getElementById("map"), {
      center,
      zoom: 14,
    });
  };

  function clearMarkers() {
    markers.forEach((m) => m.setMap(null));
    markers = [];
    markerById.clear();
  }

  function renderMarkersFromResults(results, origin) {
    if (!map) return;
    clearMarkers();
    const bounds = new google.maps.LatLngBounds();

    if (
      origin &&
      typeof origin.lat === "number" &&
      typeof origin.lng === "number"
    ) {
      const originPos = { lat: origin.lat, lng: origin.lng };
      const originMarker = new google.maps.Marker({
        position: originPos,
        map,
        title: "Your location",
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 6,
          fillColor: "#2563eb",
          fillOpacity: 1,
          strokeColor: "#ffffff",
          strokeWeight: 2,
        },
      });
      markers.push(originMarker);
      bounds.extend(originPos);
    }

    results.forEach((r) => {
      if (typeof r.lat !== "number" || typeof r.lng !== "number") return;
      const pos = { lat: r.lat, lng: r.lng };
      const marker = new google.maps.Marker({
        position: pos,
        map,
        title: r.name || "(no name)",
      });
      markers.push(marker);
      markerById.set(r.id, marker);
      bounds.extend(pos);

      marker.addListener("click", () => {
        const card = document.querySelector(
          `.result-card[data-id="${r.id}"]`
        );
        if (card) {
          card.scrollIntoView({ behavior: "smooth", block: "center" });
          card.classList.add("active");
          setTimeout(() => card.classList.remove("active"), 800);
        }
      });
    });

    if (!bounds.isEmpty()) {
      map.fitBounds(bounds);
    }
  }

  function focusMarkerById(id) {
    const m = markerById.get(id);
    if (!m || !map) return;
    map.panTo(m.getPosition());
    map.setZoom(16);
    m.setAnimation(google.maps.Animation.BOUNCE);
    setTimeout(() => m.setAnimation(null), 700);
  }

  // --- DOM refs ---
  const f = document.getElementById("f");
  const lat = document.getElementById("lat");
  const lng = document.getElementById("lng");
  const radius = document.getElementById("radius");
  const mode = document.getElementById("mode");
  const openNow = document.getElementById("openNow");
  const keyword = document.getElementById("keyword");
  const out = document.getElementById("results");
  const outHead = document.getElementById("results-head");
  const btn = document.getElementById("submitBtn");
  const geoBtn = document.getElementById("geo");
  const address = document.getElementById("address");
  const resolveBtn = document.getElementById("resolve");
  const minRating = document.getElementById("minRating");
  const priceLevels = document.getElementById("priceLevels");
  const page = document.getElementById("page");
  const pageSize = document.getElementById("pageSize");

  // --- Buttons ---
  geoBtn.onclick = (e) => {
    e.preventDefault();
    if (!navigator.geolocation) {
      alert("Your browser does not support geolocation.");
      return;
    }
    geoBtn.disabled = true;
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        lat.value = pos.coords.latitude.toFixed(6);
        lng.value = pos.coords.longitude.toFixed(6);
        geoBtn.disabled = false;
      },
      (err) => {
        alert(err.message);
        geoBtn.disabled = false;
      }
    );
  };

  resolveBtn.onclick = async (e) => {
    e.preventDefault();
    const q = address.value.trim();
    if (!q) {
      alert("Enter the destination first");
      return;
    }

    resolveBtn.disabled = true;
    const oldText = resolveBtn.textContent;
    resolveBtn.textContent = "Resolving...";

    try {
      const r = await resolveAddress(q);
      if (!r.ok) {
        alert(
          'Try Again (Eg: "Central Station, Sydney NSW").'
        );
        return;
      }
      lat.value = r.lat.toFixed(6);
      lng.value = r.lng.toFixed(6);
    } catch (err) {
      alert("Resolve error: " + (err.message || err));
    } finally {
      resolveBtn.disabled = false;
      resolveBtn.textContent = oldText;
    }
  };

  // --- Submit search ---
  f.onsubmit = async (e) => {
    e.preventDefault();
    btn.disabled = true;
    const old = btn.textContent;
    btn.textContent = "Searching...";
    out.textContent = "Loading...";
    outHead.textContent = "";

    try {
      const body = {
        lat: Number(lat.value),
        lng: Number(lng.value),
        radius: Number(radius.value),
        openNow: openNow.checked,
        keyword: keyword.value.trim() || undefined,
        minRating: Number(minRating.value || 0),
        priceLevels: selectedPriceLevels(),
        page: Number(page.value || 1),
        pageSize: Number(pageSize.value || 10),
        max: Number(pageSize.value || 10),
        mode: mode.value,
      };

      const data = await api(body);
      if (data.error) {
        out.textContent = "API error: " + data.error;
        return;
      }

      const items = data.results || [];
      const totalPages = Math.max(
        1,
        Math.ceil((data.total || 0) / (data.pageSize || 1))
      );
      outHead.textContent = `Total (filtered): ${data.total || 0}, page ${
        data.page
      }/${totalPages}`;

      if (!items.length) {
        out.textContent = "No results.";
      } else {
        out.innerHTML = items
          .map(
            (r) => `
            <article class="result-card" data-id="${r.id}">
              <div class="result-header">
                <div class="result-name">
                  ${r.name || "(no name)"}
                  ${r.rating ? ` • ⭐ ${r.rating}` : ""}
                  ${
                    Number.isFinite(r.priceLevel)
                      ? ` • ${priceText(r.priceLevel)}`
                      : ""
                  }
                </div>
              </div>
              <div class="result-meta">${r.address || ""}</div>
              <div class="dur">${
                r.travel
                  ? (r.travel.durationText || "") +
                    " • " +
                    (r.travel.distanceText || "")
                  : "—"
              }</div>
              <div class="chips">
                ${
                  r.isOpenNow === true
                    ? '<span class="tag">Open now</span>'
                    : ""
                }
                ${
                  r.isOpenNow === false
                    ? '<span class="tag">Closed</span>'
                    : ""
                }
              </div>
              <div class="result-meta">
                <a href="${r.mapsUrl}" target="_blank">Maps</a>
                ${
                  r.website
                    ? ' • <a href="' +
                      r.website +
                      '" target="_blank">Website</a>'
                    : ""
                }
                ${
                  r.phone
                    ? ' • <a href="tel:' + r.phone + '">' + r.phone + "</a>"
                    : ""
                }
              </div>
            </article>
          `
          )
          .join("");
      }

      // card click -> focus marker
      document
        .querySelectorAll('.result-card[data-id]')
        .forEach((card) => {
          card.addEventListener("click", () => {
            const id = card.getAttribute("data-id");
            if (id) focusMarkerById(id);
          });
        });

      // update markers
      renderMarkersFromResults(items, data.origin);
    } catch (err) {
      out.textContent = "Error: " + (err.message || err);
    } finally {
      btn.disabled = false;
      btn.textContent = old;
    }
  };
</script>


  <!-- Maps JavaScript API -->
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyACSc47eVPio6BbWR8epgFei22qtZ3mKZw&callback=initMap"></script>
</body>
</html>
